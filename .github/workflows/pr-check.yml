name: Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]

jobs:
  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
          requireScope: false
        continue-on-error: true

      - name: Check for version bump
        run: |
          git fetch origin ${{ github.base_ref }}
          BASE_VERSION=$(git show origin/${{ github.base_ref }}:version.txt)
          PR_VERSION=$(cat version.txt)
          echo "Base version: $BASE_VERSION"
          echo "PR version: $PR_VERSION"
          if [ "$BASE_VERSION" = "$PR_VERSION" ] && [ "${{ github.base_ref }}" = "main" ]; then
            echo "⚠️ Warning: Version number not updated"
            exit 1
          fi
        continue-on-error: true

      - name: Check file sizes
        run: |
          # Check for large files that shouldn't be committed
          find . -type f -size +1M -not -path "./.git/*" -not -path "./.pio/*" -not -path "./webui/node_modules/*" | while read file; do
            echo "⚠️ Large file detected: $file ($(du -h "$file" | cut -f1))"
          done

      - name: Validate CHANGELOG
        run: |
          if ! grep -q "$PR_VERSION" CHANGELOG.md; then
            echo "⚠️ Warning: Version $PR_VERSION not found in CHANGELOG.md"
            exit 1
          fi
        continue-on-error: true

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webui/package-lock.json

      - name: Install WebUI dependencies
        run: |
          cd webui
          npm ci

      - name: Check for console.log statements
        run: |
          cd webui
          if grep -r "console\.log" --include="*.js" --include="*.vue" .; then
            echo "⚠️ Warning: console.log statements found in code"
          fi
        continue-on-error: true

      - name: Check WebUI build
        run: |
          cd webui
          npm run build

      - name: Validate JSON files
        run: |
          for file in $(find . -name "*.json" -not -path "./node_modules/*" -not -path "./.pio/*" -not -path "./webui/node_modules/*"); do
            echo "Validating $file"
            python3 -m json.tool "$file" > /dev/null || exit 1
          done

  size-check:
    name: Firmware Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webui/package-lock.json

      - name: Build WebUI
        run: |
          cd webui
          npm ci
          npm run build

      - name: Cache PlatformIO
        uses: actions/cache@v5
        with:
          path: |
            ~/.platformio
            .pio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Build and check firmware size
        run: |
          pio run -e hb-rf-eth-ng --verbose

      - name: Report firmware size
        run: |
          echo "### Firmware Size Report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          pio run -e hb-rf-eth-ng -t size >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Check WebUI size
        run: |
          echo "### WebUI Size Report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          du -h webui/dist/*.gz >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
